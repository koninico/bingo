<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>管理画面</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }
    h1 { margin-bottom: 8px; }
    .box { border:1px solid #ddd; padding:10px; margin:12px 0; border-radius:6px; max-width:840px; }
    button { font-size:16px; padding:8px 12px; margin-right:8px; }
    .muted { color:#666; }
    pre { background:#f3f3f3; padding:8px; white-space:pre-wrap; }

    table { border-collapse: collapse; width: 100%; }
    th, td { border:1px solid #ddd; padding:6px 8px; font-size:14px; }
    th { background:#f5f5f5; text-align:left; }
    .actions button { font-size:14px; padding:6px 10px; }
  </style>
</head>
<body>
  <h1>管理画面</h1>

  <!-- 続きから / 最初から -->
  <div class="box">
    <h2 style="margin:0 0 8px;">起動時の選択</h2>
    <div class="muted" id="resumeInfo">読み込み中...</div>
    <p>
      <button id="btnResume">続きから（抽選へ）</button>
      <button id="btnReset">最初から（続きデータ破棄）</button>
    </p>
    <div class="muted">※「最初から」は latest.json を消します。イベント履歴ファイルは残ります。</div>
  </div>

  <!-- 新規イベント作成 -->
  <div class="box">
    <h2 style="margin:0 0 8px;">新規イベント作成</h2>
    <div>
      <label>
        イベント名：
        <input id="eventName" value="柳町子ども会ビンゴ" />
      </label>
    </div>
    <div style="margin-top:6px;">
      <label>
        当選者数（目安）：
        <input id="winnersTarget" type="number" value="10" min="0" />
      </label>
    </div>

    <p style="margin-top:10px;">
      <button id="btnNew">新規イベント作成</button>
      <button id="btnOpenDraw">抽選画面へ</button>
    </p>
  </div>

  <!-- 過去イベント一覧 -->
  <div class="box">
    <h2 style="margin:0 0 8px;">過去イベント一覧</h2>
    <div class="muted" style="margin-bottom:8px;">「これを開く」で、そのイベントを latest にして「続きから」できます。</div>
    <p>
      <button id="btnReloadEvents">一覧を更新</button>
    </p>
    <div id="eventsArea" class="muted">読み込み中...</div>
  </div>

  <details>
    <summary>デバッグ（API応答）</summary>
    <pre id="out"></pre>
  </details>

  <script>
    const out = document.getElementById("out");
    const resumeInfo = document.getElementById("resumeInfo");
    const btnResume = document.getElementById("btnResume");
    const btnReset = document.getElementById("btnReset");
    const eventsArea = document.getElementById("eventsArea");

    let state = null;
    let events = [];

    async function api(path, method="GET", body=null) {
      const opt = { method, headers: {} };
      if (body) {
        opt.headers["Content-Type"] = "application/json";
        opt.body = JSON.stringify(body);
      }
      const res = await fetch(path, opt);
      const j = await res.json().catch(() => ({}));
      if (!res.ok || j.ok === false) {
        throw new Error(j.error || `HTTP ${res.status}`);
      }
      return j;
    }

    function renderResume() {
      if (!state) {
        resumeInfo.textContent = "続きデータはありません（新規イベントを作成してください）";
        btnResume.disabled = true;
        btnReset.disabled = true;
      } else {
        resumeInfo.textContent = `最新イベント：${state.eventName} / 状態：${state.status} / 残り：${state.remainingCount} / 引いた数：${(state.drawnOrder||[]).length}`;
        btnResume.disabled = false;
        btnReset.disabled = false;
        btnResume.textContent = (state.status === "ended")
          ? "結果を見る（抽選へ）"
          : "続きから（抽選へ）";

      }
    }

    function renderEvents() {
      if (!events.length) {
        eventsArea.textContent = "過去イベントがありません。";
        return;
      }

      const rows = events.map((e, idx) => {
        const created = e.createdAt || "";
        const status = e.status || "";
        const remain = (e.remainingCount ?? "");
        const drawCount = (e.drawCount ?? "");
        const name = e.eventName || e.fileName;

        return `
          <tr>
            <td>${idx + 1}</td>
            <td>${name}</td>
            <td>${created}</td>
            <td>${status}</td>
            <td>${drawCount}</td>
            <td>${remain}</td>
            <td class="actions">
              <button data-use="${encodeURIComponent(e.eventFile)}">これを開く</button>
              <button data-del="${encodeURIComponent(e.eventFile)}">削除</button>
            </td>
          </tr>
        `;
      }).join("");

      eventsArea.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>イベント名</th>
              <th>作成日時</th>
              <th>状態</th>
              <th>引いた数</th>
              <th>残り</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      // ボタン配線
      eventsArea.querySelectorAll("button[data-use]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const eventFile = decodeURIComponent(btn.dataset.use);
          if (!confirm(`このイベントを「続き（latest）」として開きます。\n\n${eventFile}\n\nよろしいですか？`)) return;

          const j = await api("/api/use", "POST", { eventFile });
          state = j.state;
          renderResume();
          out.textContent = JSON.stringify(j, null, 2);
          alert("最新イベント（latest）を切り替えました。必要なら「続きから（抽選へ）」へ。");
        });
      });

      eventsArea.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const eventFile = decodeURIComponent(btn.dataset.del);
          if (!confirm(`このイベントを削除します。\n元に戻せません。\n\n${eventFile}\n\nよろしいですか？`)) return;

          try {
            const j = await api("/api/delete", "POST", { eventFile });
            out.textContent = JSON.stringify(j, null, 2);
            await refreshState();   // latestが消えた可能性があるので再取得
            await refreshEvents();  // 一覧更新
            alert("削除しました。");
          } catch (e) {
            alert(e.message);
          }
        });
      });
    }

    async function refreshState() {
      const j = await api("/api/state");
      state = j.state;
      renderResume();
      out.textContent = JSON.stringify(j, null, 2);
    }

    async function refreshEvents() {
      const j = await api("/api/events");
      events = j.events || [];
      renderEvents();
      // out.textContent は state の方を優先したいのでここでは触らない
    }

    async function apiNewEvent() {
      const eventName = document.getElementById("eventName").value;
      const winnersTarget = Number(document.getElementById("winnersTarget").value || 0);
      const j = await api("/api/new", "POST", { eventName, winnersTarget });
      state = j.state;
      renderResume();
      out.textContent = JSON.stringify(j, null, 2);
      await refreshEvents();
    }

    async function apiReset() {
      if (!confirm("続きデータ（latest.json）を削除して、最初からにします。よろしいですか？")) return;
      const j = await api("/api/reset", "POST");
      state = null;
      renderResume();
      out.textContent = JSON.stringify(j, null, 2);
    }

    // ボタン
    document.getElementById("btnNew").addEventListener("click", apiNewEvent);
    document.getElementById("btnOpenDraw").addEventListener("click", () => location.href = "/draw");
    btnResume.addEventListener("click", () => location.href = "/draw");
    btnReset.addEventListener("click", apiReset);
    document.getElementById("btnReloadEvents").addEventListener("click", refreshEvents);

    // 起動時
    (async () => {
      try {
        await refreshState();
        await refreshEvents();
      } catch (err) {
        resumeInfo.textContent = `エラー: ${err.message}`;
        btnResume.disabled = true;
        btnReset.disabled = true;
        eventsArea.textContent = `エラー: ${err.message}`;
      }
    })();
  </script>
</body>
</html>
